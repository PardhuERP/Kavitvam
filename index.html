<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="UTF-8">
<title>Kavitvam</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  margin:0;
  background:#f4f1ec;
  font-family:'Noto Serif Telugu',serif;
}

header{
  background:#6a1b9a;
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:20px;
}

/* üåô NIGHT MODE */
body.night{
  background:#121212;
  color:#e0e0e0;
}
body.night header{
  background:#1f1f1f;
}
body.night .popup-content{
  background:#1e1e1e;
  color:#e0e0e0;
}
body.night .book-footer,
body.night .popup-author,
body.night .book-date,
body.night .like-count{
  color:#bbb;
}
  body.night input{
  background:#1e1e1e;
  color:#e0e0e0;
  border:1px solid #444;
  }

  /* üîç SEARCH BAR */
.search-bar{
  padding:8px 12px;
}

.search-bar input{
  width:100%;
  padding:8px 12px;
  font-size:14px;
  border-radius:20px;
  border:1px solid #ccc;
  outline:none;
  box-sizing:border-box;
}

/* üåô Night mode search */
body.night .search-bar input{
  background:#1e1e1e;
  color:#e0e0e0;
  border:1px solid #444;
}

/* LOADING */
#loading{
  text-align:center;
  padding:15px;
  color:#888;
}

/* BOOK GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(110px, 1fr));
  gap:12px;
  padding:12px;
}

.book{
  border-radius:8px;
  padding:10px;
  height:150px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* TITLE */
.book-title{
  font-weight:bold;
  font-size:14px;
  line-height:1.3;
  max-height:36px;
  overflow:hidden;
}

/* FOOTER */
.book-footer{
  font-size:11px;
  color:#555;
}
.book-date{
  font-size:10px;
  color:#777;
}

/* ‚ù§Ô∏è LIKE ON BOOK */
.book-like{
  font-size:16px;
  align-self:flex-end;
  cursor:pointer;
  user-select:none;
}
.book-like.liked{
  color:red;
}

/* ‚ù§Ô∏è COUNT */
.like-count{
  font-size:11px;
  margin-left:4px;
  color:#444;
}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.popup-content{
  background:#fff;
  width:90%;
  max-height:80%;
  overflow:auto;
  padding:18px;
  border-radius:10px;
}

.popup-title{
  font-size:20px;
  font-weight:bold;
}

.popup-text{
  margin-top:10px;
  line-height:1.9;
  white-space:pre-line;
}

.popup-author{
  margin-top:12px;
  font-size:13px;
  color:#666;
}

/* ‚ù§Ô∏è LIKE IN POPUP */
.like-btn{
  margin-top:12px;
  font-size:18px;
  cursor:pointer;
  user-select:none;
}
.like-btn.liked{
  color:red;
  font-weight:bold;
}

.close{
  margin-top:15px;
  text-align:center;
  color:#6a1b9a;
  font-weight:bold;
  cursor:pointer;
}

/* BOOK COLORS */
.c1{background:#fff8e1;}
.c2{background:#e3f2fd;}
.c3{background:#e8f5e9;}
.c4{background:#fce4ec;}
.c5{background:#ede7f6;}
.c6{background:#f3e5f5;}
</style>
</head>

<body>

<header>
  ‡∞®‡∞æ ‡∞ï‡∞µ‡∞ø‡∞§‡±ç‡∞µ‡∞Ç
  <span id="modeToggle"
        style="float:right;cursor:pointer;font-size:18px"
        onclick="toggleMode()">üåô</span>
</header>

  <div class="search-bar">
  <input type="text" id="searchInput"
         placeholder="‡∞ï‡∞µ‡∞ø‡∞§‡±ç‡∞µ‡∞Ç ‡∞µ‡±Ü‡∞§‡∞ï‡∞Ç‡∞°‡∞ø..."
         onkeyup="applySearch()">
  </div>

<div id="loading">‡∞ï‡∞µ‡∞ø‡∞§‡±ç‡∞µ‡∞Ç ‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
<div class="grid" id="grid"></div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content" onclick="event.stopPropagation()">
    <div class="popup-title" id="pTitle"></div>
    <div class="popup-text" id="pText"></div>
    <div class="popup-author" id="pAuthor"></div>

    <div class="like-btn" id="likeBtn" onclick="toggleLike()">ü§ç Like</div>

    <div class="close" onclick="closePopup()">‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø</div>
  </div>
</div>

<script>
const API =
"https://script.google.com/macros/s/AKfycbwTmmsNCd_Ok_Otn38XmikzRBgfeJr35eQul0PA_mC3_eC3jwDJ2vNqWbcUAqCvaQqu/exec";

let poems=[];
let currentIndex=null;

/* UNUSED BUT KEPT AS REQUESTED */
function getPoemId(p){
  return p["kavitha id"];
}

fetch(API+"?t="+Date.now())
.then(r=>r.json())
.then(data=>{
  poems=data.reverse();
  document.getElementById("loading").style.display="none";
  render();
});

let filteredPoems = [];
function render(){
  let likes = JSON.parse(localStorage.getItem("likes")||"{}");
  let counts = JSON.parse(localStorage.getItem("likeCounts")||"{}");
  let html="";

  (filteredPoems.length ? filteredPoems : poems).forEach((p,i)=>{
    let colorClass="c"+((i%6)+1);
    let liked = likes[i];
    let count = counts[i] || 0;

    html+=`
    <div class="book ${colorClass}">
      <div class="book-title" onclick="openPoem(${i})">${p.title}</div>

      <div class="book-footer" onclick="openPoem(${i})">
        ‚úç ${p.author}<br>
        <span class="book-date">üìÖ ${p.date||""}</span>
      </div>

      <div class="book-like ${liked?'liked':''}"
           onclick="toggleLikeFromBook(event, ${i})">
        ${liked?'‚ù§Ô∏è':'ü§ç'}
        <span class="like-count">${count}</span>
      </div>
    </div>`;
  });

  document.getElementById("grid").innerHTML=html;
}

function openPoem(i){
  currentIndex=i;
  let p=poems[i];

  document.getElementById("pTitle").innerText=p.title;
  document.getElementById("pText").innerText=p.kavitvam;
  document.getElementById("pAuthor").innerText="‚úç "+p.author+" | "+(p.date||"");

  updateLikeUI();
  document.getElementById("popup").style.display="flex";
}

function closePopup(){
  document.getElementById("popup").style.display="none";
}

/* ‚ù§Ô∏è POPUP LIKE */
function toggleLike(){
  let likes = JSON.parse(localStorage.getItem("likes")||"{}");
  let counts = JSON.parse(localStorage.getItem("likeCounts")||"{}");

  let id = currentIndex;
  likes[id] = !likes[id];

  if(likes[id]){
    counts[id] = (counts[id]||0) + 1;
  }else{
    counts[id] = Math.max((counts[id]||1) - 1, 0);
  }

  localStorage.setItem("likes", JSON.stringify(likes));
  localStorage.setItem("likeCounts", JSON.stringify(counts));

  updateLikeUI();
  render();
}

/* ‚ù§Ô∏è BOOK LIKE */
function toggleLikeFromBook(e, i){
  e.stopPropagation();

  let likes = JSON.parse(localStorage.getItem("likes")||"{}");
  let counts = JSON.parse(localStorage.getItem("likeCounts")||"{}");

  likes[i] = !likes[i];

  if(likes[i]){
    counts[i] = (counts[i]||0) + 1;
  }else{
    counts[i] = Math.max((counts[i]||1) - 1, 0);
  }

  localStorage.setItem("likes", JSON.stringify(likes));
  localStorage.setItem("likeCounts", JSON.stringify(counts));

  render();
  updateLikeUI();
}

function updateLikeUI(){
  if(currentIndex===null) return;

  let likes = JSON.parse(localStorage.getItem("likes")||"{}");
  let counts = JSON.parse(localStorage.getItem("likeCounts")||"{}");
  let id = currentIndex;
  let btn=document.getElementById("likeBtn");

  let count = counts[id] || 0;

  if(likes[id]){
    btn.innerText="‚ù§Ô∏è Liked ("+count+")";
    btn.classList.add("liked");
  }else{
    btn.innerText="ü§ç Like ("+count+")";
    btn.classList.remove("liked");
  }
}

/* üåô NIGHT MODE */
function toggleMode(){
  let isNight = document.body.classList.toggle("night");
  localStorage.setItem("nightMode", isNight ? "on" : "off");
  document.getElementById("modeToggle").innerText = isNight ? "‚òÄÔ∏è" : "üåô";
}

(function(){
  let saved = localStorage.getItem("nightMode");
  if(saved === "on"){
    document.body.classList.add("night");
    document.getElementById("modeToggle").innerText = "‚òÄÔ∏è";
  }
})();

function applySearch(){
  let q = document.getElementById("searchInput").value.toLowerCase();

  if(!q){
    filteredPoems = [];
    render();
    return;
  }

  filteredPoems = poems.filter(p =>
    (p.title && p.title.toLowerCase().includes(q)) ||
    (p.author && p.author.toLowerCase().includes(q))
  );

  render();
}
</script>

</body>
</html>
