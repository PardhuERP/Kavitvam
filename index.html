<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="UTF-8">
<title>Kavitvam</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
/* ===== BASE ===== */
body{margin:0;background:#f4f1ec;font-family:'Noto Serif Telugu',serif;}
header{background:#6a1b9a;color:#fff;padding:14px;text-align:center;font-size:20px;}
body.night{background:#121212;color:#e0e0e0;}
body.night header{background:#1f1f1f;}
body.night .popup-content{background:#1e1e1e;color:#e0e0e0;}
body.night .book-footer,
body.night .popup-author,
body.night .book-date,
body.night .like-count{color:#bbb;}
body.night input{background:#1e1e1e;color:#e0e0e0;border:1px solid #444;}

.search-bar{padding:8px 12px;}
.search-bar input{width:100%;padding:8px 12px;font-size:14px;border-radius:20px;border:1px solid #ccc;}

.category-bar{display:flex;gap:8px;overflow-x:auto;padding:6px 12px 10px;}
.category-btn{padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:#fff;font-size:13px;cursor:pointer;}
.category-btn.active{background:#6a1b9a;color:#fff;}

#loading{text-align:center;padding:15px;color:#888;}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px;padding:12px;}
.book{border-radius:8px;padding:10px;height:150px;box-shadow:0 2px 6px rgba(0,0,0,0.15);display:flex;flex-direction:column;justify-content:space-between;}

.book-title{font-weight:bold;font-size:14px;max-height:36px;overflow:hidden;}
.book-footer{font-size:11px;color:#555;}
.book-date{font-size:10px;color:#777;}

.book-like{font-size:16px;align-self:flex-end;cursor:pointer;}
.book-like.liked{color:red;}
.like-count{font-size:11px;margin-left:4px;color:#444;}

.popup{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;}
.popup-content{background:#fff;width:90%;max-height:80%;overflow:auto;padding:18px;border-radius:10px;}
.popup-title{font-size:20px;font-weight:bold;}
.popup-text{margin-top:10px;line-height:1.9;white-space:pre-line;}
.popup-author{margin-top:12px;font-size:13px;color:#666;}
.like-btn{margin-top:12px;font-size:18px;cursor:pointer;}
.like-btn.liked{color:red;font-weight:bold;}
.close{margin-top:15px;text-align:center;color:#6a1b9a;font-weight:bold;cursor:pointer;}

.c1{background:#fff8e1;}
.c2{background:#e3f2fd;}
.c3{background:#e8f5e9;}
.c4{background:#fce4ec;}
.c5{background:#ede7f6;}
.c6{background:#f3e5f5;}

.author-row{display:flex;align-items:center;gap:6px;}
.author-img{width:18px;height:18px;border-radius:50%;object-fit:cover;}

/* MENU */
#menu{position:fixed;top:14px;left:12px;font-size:22px;cursor:pointer;z-index:9999;color:#fff}
#menuBox{position:fixed;top:50px;left:12px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.3);display:none;z-index:9999}
#menuBox div{padding:10px 14px;cursor:pointer}
#menuBox div:hover{background:#eee}
</style>
</head>

<body>

<header>
  ‡∞®‡∞æ ‡∞ï‡∞µ‡∞ø‡∞§‡±ç‡∞µ‡∞Ç
  <span id="modeToggle" style="float:right;cursor:pointer" onclick="toggleMode()">üåô</span>
</header>

<div id="menu" onclick="openMenu()">‚ò∞</div>
<div id="menuBox">
  <div onclick="openLogin()">Login</div>
</div>

<div class="search-bar">
  <input id="searchInput" placeholder="‡∞ï‡∞µ‡∞ø‡∞§‡±ç‡∞µ‡∞Ç ‡∞µ‡±Ü‡∞§‡∞ï‡∞Ç‡∞°‡∞ø..." onkeyup="applySearch()">
</div>

<div class="category-bar" id="categoryBar"></div>

<div id="loading">‡∞ï‡∞µ‡∞ø‡∞§‡±ç‡∞µ‡∞Ç ‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
<div class="grid" id="grid"></div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content" onclick="event.stopPropagation()">
    <div class="popup-title" id="pTitle"></div>
    <div class="popup-text" id="pText"></div>
    <div class="popup-author" id="pAuthor"></div>
    <div class="like-btn" id="likeBtn" onclick="toggleLike()">ü§ç Like</div>
    <div class="close" onclick="closePopup()">‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø</div>
  </div>
</div>

<!-- LOGIN -->
<div class="popup" id="loginPopup">
  <div class="popup-content">
    <h3>Admin Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <div class="close" onclick="closeLogin()">Close</div>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwTmmsNCd_Ok_Otn38XmikzRBgfeJr35eQul0PA_mC3_eC3jwDJ2vNqWbcUAqCvaQqu/exec";

let poems=[],filteredPoems=[],currentList=[],currentIndex=null,selectedCategory="All";

const menu=document.getElementById("menu");
const menuBox=document.getElementById("menuBox");

document.addEventListener("click",e=>{
  if(!menu.contains(e.target)&&!menuBox.contains(e.target)){
    menuBox.style.display="none";
  }
});

fetch(API)
.then(r=>r.json())
.then(d=>{
  poems=d.reverse();
  loading.style.display="none";
  buildCategories();
  render();
});

/* RENDER */
function render(){
  let likes=JSON.parse(localStorage.getItem("likes")||"{}");
  let counts=JSON.parse(localStorage.getItem("likeCounts")||"{}");
  currentList=filteredPoems.length?filteredPoems:poems;

  grid.innerHTML=currentList.map((p,i)=>`
    <div class="book c${i%6+1}">
      <div class="book-title" onclick="openPoem(${i})">${p.title}</div>

      <div class="book-footer" onclick="openPoem(${i})">
        <div class="author-row">
          <span>‚úç ${p.author}</span>
          <img src="author.png" class="author-img">
        </div>
        <span class="book-date">üìÖ ${p.date}</span>
      </div>

      <div class="book-like ${likes[i]?'liked':''}"
           onclick="toggleLikeFromBook(event,${i})">
        ${likes[i]?'‚ù§Ô∏è':'ü§ç'}
        <span class="like-count">${counts[i]||0}</span>
      </div>
    </div>
  `).join("");
}

function openPoem(i){
  currentIndex=i;
  let p=currentList[i];
  pTitle.innerText=p.title;
  pText.innerText=p.kavitvam;
  pAuthor.innerText="‚úç "+p.author+" | "+p.date;
  updateLikeUI();
  popup.style.display="flex";
}
function closePopup(){popup.style.display="none";}

/* MENU */
function openMenu(){menuBox.style.display=menuBox.style.display==="block"?"none":"block";}
function openLogin(){menuBox.style.display="none";loginPopup.style.display="flex";}
function closeLogin(){loginPopup.style.display="none";}

/* LOGIN */
function login(){
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"login",
    email:email.value,
    password:password.value
  })})
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="ok"){
      localStorage.setItem("adminToken",res.token);
      loginPopup.style.display="none";
    }else alert("Invalid login");
  });
}

/* LIKE */
function toggleLike(){
  let likes=JSON.parse(localStorage.getItem("likes")||"{}");
  let counts=JSON.parse(localStorage.getItem("likeCounts")||"{}");
  likes[currentIndex]=!likes[currentIndex];
  counts[currentIndex]=(counts[currentIndex]||0)+(likes[currentIndex]?1:-1);
  if(counts[currentIndex]<0)counts[currentIndex]=0;
  localStorage.setItem("likes",JSON.stringify(likes));
  localStorage.setItem("likeCounts",JSON.stringify(counts));
  updateLikeUI();render();
}
function toggleLikeFromBook(e,i){e.stopPropagation();currentIndex=i;toggleLike();}
function updateLikeUI(){
  let likes=JSON.parse(localStorage.getItem("likes")||"{}");
  let counts=JSON.parse(localStorage.getItem("likeCounts")||"{}");
  likeBtn.innerText=(likes[currentIndex]?"‚ù§Ô∏è Liked ":"ü§ç Like ")+"("+ (counts[currentIndex]||0)+")";
  likeBtn.classList.toggle("liked",likes[currentIndex]);
}

/* SEARCH + CATEGORY */
function buildCategories(){
  let cats=new Set(["All"]);
  poems.forEach(p=>p.category&&cats.add(p.category));
  categoryBar.innerHTML=[...cats].map(c=>
    `<div class="category-btn ${c==="All"?"active":""}" onclick="selectCategory('${c}')">${c}</div>`
  ).join("");
}
function selectCategory(c){
  selectedCategory=c;
  document.querySelectorAll(".category-btn").forEach(b=>b.classList.toggle("active",b.innerText===c));
  applyFilters();
}
function applySearch(){applyFilters();}
function applyFilters(){
  let q=searchInput.value.toLowerCase();
  filteredPoems=poems.filter(p=>{
    let t=!q||p.title.toLowerCase().includes(q)||p.author.toLowerCase().includes(q);
    let c=selectedCategory==="All"||p.category===selectedCategory;
    return t&&c;
  });
  render();
}

/* NIGHT MODE */
function toggleMode(){
  document.body.classList.toggle("night");
  localStorage.setItem("nightMode",document.body.classList.contains("night")?"on":"off");
  modeToggle.innerText=document.body.classList.contains("night")?"‚òÄÔ∏è":"üåô";
}
if(localStorage.getItem("nightMode")==="on"){
  document.body.classList.add("night");
  modeToggle.innerText="‚òÄÔ∏è";
}
</script>

</body>
</html>
